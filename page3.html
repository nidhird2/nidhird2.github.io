<!DOCTYPE html>
<meta charset="utf-8">
<style>

.point {
  fill: #2f225d;
  stroke: #afa2dc;
}

.selected {
  fill: #afa2dc;
  stroke: #2f225d;
}
.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}
.clear-button {
  font: 14px sans-serif;
  cursor: pointer;
}
.brush .extent {
  stroke: #fff;
  fill-opacity: .125;
  shape-rendering: crispEdges;
}

.dot {
  stroke: #000;
}
.tooltip {
            position: absolute;
            font-size: 12px;
            width:  auto;
            height: auto;
            pointer-events: none;
			background: white;
			border: 1px black;
			color: black;
        }    
        body {
        margin: 0;
        padding: 0; }
        h1 { 
          color : black;
          font-family: 'Barlow', sans-serif;
          text-align: center;
        }
        p {
          color : black;
          font-family: 'Barlow', sans-serif;
          text-align: center;
          font-size: 18px;
        }
</style>
<head>
    <link rel="stylesheet" type="text/css" href="css/viz.css"/>
    <link href="https://fonts.googleapis.com/css?family=Barlow" rel="stylesheet">
    <title>Covid Case Factors in IL</title>
  </head>
<h1> How do institution covid rates contribute to overall covid cases and deaths?</h1>  
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
<p>
  We can now explore the overall contributions of colleges and prisons on covid deaths. Hover over data points to see further statistics, and zoom in to areas in the graph to get a clearer picture.
</p>

<div id="my_dataviz3"></div>

<svg width="1000" height="500"></svg>
<script>
/*
var mousemove = function(d) {
    tooltip
      .html("County: " + d.county + "<br/>"
      + "Covid cases: " + d.cases  + "<br/>"
      + "Covid deaths:" + d.deaths + "<br/>"
      + "College cases:" + d.college_cases + "<br/>"
      + "Prison cases:" + d.total_inmate_cases)
      .style("left", (d3.mouse(this)[0]+90) + "px") // It is important to put the +90: other wise the tooltip is exactly where the point is an it creates a weird effect
      .style("top", (d3.mouse(this)[1]) + "px")
  }
*/  
d3.helper = {};
d3.helper.tooltip = function(){
    var tooltipDiv;
    var bodyNode = d3.select('body').node();

    function tooltip(selection){

        selection.on('mouseover.tooltip', function(pD, pI){
            // Clean up lost tooltips
            d3.select('body').selectAll('div.tooltip').remove();
            // Append tooltip
            tooltipDiv = d3.select('body')
                           .append('div')
                           .attr('class', 'tooltip')
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style({
                left: (absoluteMousePos[0] + 10)+'px',
                top: (absoluteMousePos[1] - 40)+'px',
                'background-color': '#d8d5e4',
                width: '110px',
                height: '70px',
                padding: '5px',
                position: 'absolute',
                'z-index': 1001,
                'box-shadow': '0 1px 2px 0 #656565'
            });

            tooltipDiv.html("County: " + pD.county + "<br/>"
              + "Covid cases: " + pD.cases  + "<br/>"
              + "Covid deaths:" + pD.deaths + "<br/>"
              + "College cases:" + pD.college_cases + "<br/>"
              + "Prison cases:" + pD.total_inmate_cases)
        })
        .on('mousemove.tooltip', function(pD, pI){
            // Move tooltip
            var absoluteMousePos = d3.mouse(bodyNode);
            tooltipDiv.style({
                left: (absoluteMousePos[0] + 10)+'px',
                top: (absoluteMousePos[1] - 40)+'px'
            });
        })
        .on('mouseout.tooltip', function(pD, pI){
            // Remove tooltip
            tooltipDiv.remove();
        });

    }

    tooltip.attr = function(_x){
        if (!arguments.length) return attrs;
        attrs = _x;
        return this;
    };

    tooltip.style = function(_x){
        if (!arguments.length) return styles;
        styles = _x;
        return this;
    };

    return tooltip;
};

var margin = {top: 100, right: 30, bottom: 50, left: 100},
    width = 1000 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

// append the svg object to the body of the page
//Read the data
d3.csv("data/hydrated_all.csv", function(data) {
  // Add X axis
  var x = d3.scale.linear()
    .domain([0, d3.max(data, function(d) { 
      var col = d.college_cases? Number(d.college_cases) : 0;
      var pri = d.total_inmate_cases? Number(d.total_inmate_cases) : 0;
      return col + pri + 200;
    })])
    .range([ 0, width ]);
  var xAxis = d3.svg.axis().scale(x).orient("bottom")

  // Add Y axis
  var y = d3.scale.linear()
    .domain([0, d3.max(data, function(d) { return Number(d.deaths) + 200; })])
    .range([ height, 0]);
  var yAxis = d3.svg.axis().scale(y).orient("left")

  var brush = d3.svg.brush()
  .x(x)
  .on("brush", brushmove)
  .on("brushend", brushend);  
 
  var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  svg.append("g")
      .attr("class", "x axis")
      .attr("clip-path", "url(#clip)")
      .attr("transform", "translate(0," + height + ")")
      .call(xAxis);

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis);
  
  svg.append("text")
    .attr("x", width / 2 )
    .attr("y", 0)
    .style("text-anchor", "middle")
    .attr("font-family", "Optima")
    .text("COVID: Instituition Cases vs Total Deaths By County");  
  //x axis label  
  svg.append("text")
    .attr("class", "x label")
    .attr("text-anchor", "end")
    .attr("x", width * .6)
    .attr("y", height + 40)
    .attr("font-family", "Optima")
    .text("Number of College and Prison COVID cases");  
  // y axis label  
  svg.append("text")
    .attr("class", "y label")
    .attr("text-anchor", "middle")
    .attr("y", 0-(margin.left * .8))
    .attr("x",0 - (height / 2))
    .attr("dy", "1em")
    .attr("transform", "rotate(-90)")
    .attr("font-family", "Optima")
    .text("Total COVID deaths");    

  svg.append("g")
      .attr("class", "brush")
      .call(brush)
    .selectAll('rect')
      .attr('height', height);

  svg.append("defs").append("clipPath")
      .attr("id", "clip")
    .append("rect")
      .attr("width", width)
      .attr("height", height + 20);
  
  points = svg.selectAll(".point")
    .data(data)
    .enter().append("circle")
    .attr("class", "point")
    .attr("clip-path", "url(#clip)")
    .attr("cx", function (d) { 
      var col = d.college_cases? Number(d.college_cases) : x(0);
      var pri = d.total_inmate_cases? Number(d.total_inmate_cases) : x(0);
      return x(col + pri); 
    })
    .attr("cy", function (d) { return y(Number(d.deaths)); } )
    .attr("r", 8)
    .style("stroke", "#3a158a")
    .style("fill", "#7b58db")
    .call(d3.helper.tooltip());  
  
  function brushmove() {
    var extent = brush.extent();
    points.classed("selected", function(d) {
      is_brushed = extent[0] <= d.index && d.index <= extent[1];
      return is_brushed;
  });
}

function brushend() {
  get_button = d3.select(".clear-button");
  if(get_button.empty() === true) {
    clear_button = svg.append('text')
      .attr("y", height + 40)
      .attr("x", width - 100)
      .attr("class", "clear-button")
      .text("Clear Brush");
    console.log("Added clear button!")  
  }

  x.domain(brush.extent());
  console.log(brush.extent())
  //var extent = x.domain(brush.extent());
  //x.domain([x.invert(extent[0]), x.invert(extent[1])]);

  transition_data();
  reset_axis();

  points.classed("selected", false);
  d3.select(".brush").call(brush.clear());

  clear_button.on('click', function(){
    x.domain([0, d3.max(data, function(d) { 
      var col = d.college_cases? Number(d.college_cases) : 0;
      var pri = d.total_inmate_cases? Number(d.total_inmate_cases) : 0;
      return col + pri + 200;
    })])
    //x.domain([0, d3.max(data, function(d) { return Number(d.college_cases); })]);
    transition_data();
    reset_axis();
    clear_button.remove();
  });
}

function transition_data() {
  svg.selectAll(".point")
    .data(data)
  .transition()
    .duration(500)
    .attr("cx", function (d) { 
      var col = d.college_cases? Number(d.college_cases) : x(0);
      var pri = d.total_inmate_cases? Number(d.total_inmate_cases) : x(0);
      return x(col + pri); 
    })
}

function reset_axis() {
  svg.transition().duration(500)
   .select(".x.axis")
   .call(xAxis);
}  
})

</script>


<div class="navbar">
    <a href="index.html">Home</a>
    <a href="college.html">Page 1</a>
    <a href="prison.html">Page 2</a>
    <a href="page3.html" class="active">Page 3</a>
    <a href="page4.html">Page 4</a>
</div>